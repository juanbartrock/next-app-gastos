# Cursor Rules para AplicaciÃ³n de GestiÃ³n de Gastos

## InformaciÃ³n del Proyecto
- **AplicaciÃ³n**: Sistema de gestiÃ³n de gastos personales y grupales
- **Stack**: Next.js 15, React 18, TypeScript, Prisma, PostgreSQL (Neon), NextAuth.js, OpenAI
- **UI**: TailwindCSS, Shadcn/ui, Lucide React
- **Base de datos**: PostgreSQL unificada (desarrollo y producciÃ³n con Neon)
- **ğŸ–¥ï¸ ENTORNO**: Windows 10/11 con PowerShell - NUNCA usar comandos de Linux/Bash
- **ğŸš¨ PROHIBIDO**: Borrar, truncar o eliminar datos de la base de datos bajo cualquier circunstancia

## ğŸš€ HOJA DE RUTA DE DESARROLLO 
> **Estado**: âœ… **PROYECTO 100% COMPLETADO** - 3 FASES + GASTOS RECURRENTES IMPLEMENTADOS
> 
> **Referencia**: Ver `DOCUMENTACION.md`, `GASTOS_RECURRENTES_COMPLETADO.md` y `PROYECTO_COMPLETADO_FINAL.md`

### **âœ… TODAS LAS FASES COMPLETADAS - Enero 2025**

#### **âœ… FASE 1 COMPLETADA - Sistema de Alertas Avanzado**
- âœ… Modelo `Alerta` y `ConfiguracionAlerta` en Prisma
- âœ… APIs completas para gestiÃ³n de alertas (`/api/alertas/*`)
- âœ… `NotificationCenter` implementado y funcionando
- âœ… PÃ¡gina dedicada `/alertas` con tabs (Activas, Historial, ConfiguraciÃ³n)
- âœ… Centro de notificaciones persistente en header
- âœ… 13 tipos de alerta implementados
- âœ… 4 niveles de prioridad con iconos y colores
- âœ… IntegraciÃ³n completa con VisibilityContext y ThemeProvider
- âœ… Sin duplicaciÃ³n de headers
- âœ… Acciones completas: marcar leÃ­da, accionar, eliminar

#### **âœ… FASE 2 COMPLETADA - Motor AutomÃ¡tico de Alertas**
- âœ… `AlertEngine` para evaluaciÃ³n automÃ¡tica de condiciones (8 tipos)
- âœ… `AlertScheduler` con patrÃ³n Singleton para programaciÃ³n automÃ¡tica
- âœ… APIs de control (`/api/alertas/evaluate`, `/api/alertas/scheduler`)
- âœ… Panel de administraciÃ³n en `/admin/alertas`
- âœ… PÃ¡gina de pruebas `/test-fase2` completamente funcional
- âœ… Alertas automÃ¡ticas de presupuestos (80%, 90%, 100% usado)
- âœ… Sistema de programaciÃ³n de evaluaciones cada 60 minutos
- âœ… DetecciÃ³n automÃ¡tica de gastos inusuales/anÃ³malos
- âœ… ConfiguraciÃ³n granular completa por usuario

#### **âœ… FASE 3 COMPLETADA - Inteligencia Artificial**
- âœ… `AIAnalyzer` con integraciÃ³n OpenAI completa
- âœ… 5 APIs de IA (`/api/ai/*`) funcionando correctamente
- âœ… Centro de IA `/ai-financiero` con componentes especializados
- âœ… PÃ¡gina de pruebas `/test-fase3` completamente funcional
- âœ… IntegraciÃ³n OpenAI para anÃ¡lisis de patrones (GPT-3.5-turbo, GPT-4o-mini)
- âœ… Recomendaciones personalizadas de ahorro con impacto econÃ³mico
- âœ… Alertas predictivas basadas en tendencias
- âœ… Reportes inteligentes automÃ¡ticos mensuales
- âœ… DetecciÃ³n de anomalÃ­as y gastos inusuales

#### **âœ… SISTEMA DE GASTOS RECURRENTES COMPLETADO - Enero 2025**
- âœ… **AsociaciÃ³n bidireccional** entre transacciones y gastos recurrentes
- âœ… **Estados automÃ¡ticos**: pendiente â†’ pago_parcial â†’ pagado
- âœ… **Selector en formularios** de creaciÃ³n y ediciÃ³n de transacciones
- âœ… **InformaciÃ³n visual** del impacto de pagos y saldos pendientes
- âœ… **GeneraciÃ³n automÃ¡tica** de pagos desde gastos recurrentes
- âœ… **Relaciones padre-hijo** con campo `gastoRecurrenteId`
- âœ… **API optimizada** `/api/gastos/recurrentes-disponibles`
- âœ… **Transacciones atÃ³micas** para garantizar consistencia
- âœ… **Compatibilidad Next.js 15** con `await params`
- âœ… **Manejo de timeouts** optimizado para Neon PostgreSQL

### **ğŸ¯ ESTADO ACTUAL: LISTO PARA PRODUCCIÃ“N**

#### **Funcionalidades Principales Implementadas** âœ…
- âœ… Sistema bÃ¡sico de gestiÃ³n de gastos y transacciones
- âœ… AutenticaciÃ³n con NextAuth.js
- âœ… Dashboard con visibilidad de valores (botÃ³n ojo)
- âœ… Tema oscuro por defecto
- âœ… Sistema de presupuestos con alertas automÃ¡ticas
- âœ… GestiÃ³n de prÃ©stamos e inversiones con alertas
- âœ… Panel de administraciÃ³n completo
- âœ… Sistema de scraping para promociones
- âœ… **Sistema de tareas personales y financieras**
- âœ… **SISTEMA DE ALERTAS COMPLETO (FASE 1)**
- âœ… **MOTOR AUTOMÃTICO DE ALERTAS (FASE 2)**
- âœ… **INTELIGENCIA ARTIFICIAL INTEGRADA (FASE 3)**
- âœ… **GASTOS RECURRENTES CON ASOCIACIÃ“N AUTOMÃTICA**
- âœ… **MODO FAMILIAR PARA ADMINISTRADORES** - Toggle personal/familiar con control de permisos

#### **PrÃ³ximas Expansiones Sugeridas (FASE 4+)**
- [ ] GamificaciÃ³n (badges, streaks, logros)
- [ ] Widgets personalizables en dashboard
- [ ] PWA con notificaciones push
- [ ] Integraciones bancarias argentinas (Mercado Pago, etc.)
- [ ] Chat AI conversacional 24/7
- [ ] InternacionalizaciÃ³n para otros paÃ­ses latinoamericanos

### Reglas EspecÃ­ficas para Mantenimiento ğŸ”” âœ…

#### Patrones de ImplementaciÃ³n Completados âœ…
```typescript
// Modelo base para alertas - IMPLEMENTADO Y FUNCIONAL
interface Alerta {
  id: string
  userId: string
  tipo: TipoAlerta
  prioridad: PrioridadAlerta
  titulo: string
  mensaje: string
  leida: boolean
  accionado: boolean
  fechaCreacion: Date
  fechaExpiracion?: Date
  metadatos?: Record<string, any>
  // Relaciones opcionales
  gastoRecurrenteId?: number
  prestamoId?: string
  inversionId?: string
  presupuestoId?: string
  tareaId?: string
  promocionId?: number
}

// Engine de evaluaciÃ³n de alertas - IMPLEMENTADO Y FUNCIONAL
class AlertEngine {
  async evaluateConditions(userId: string): Promise<Alerta[]>
  async processPresupuestosAlerts(userId: string): Promise<Alerta[]>
  async analyzePatterns(userId: string): Promise<Alerta[]>
  async runAutomaticEvaluation(userId: string): Promise<number>
}

// Motor de Inteligencia Artificial - IMPLEMENTADO Y FUNCIONAL
class AIAnalyzer {
  async analizarPatrones(userId: string, meses: number): Promise<PatronesAnalisis>
  async generarRecomendaciones(userId: string): Promise<RecomendacionIA[]>
  async detectarAnomalias(userId: string): Promise<AnomaliaDetectada[]>
  async generarReporte(userId: string): Promise<ReporteInteligente>
  async predecirAlertas(userId: string): Promise<AlertaPredictiva[]>
}

// Sistema de Gastos Recurrentes - IMPLEMENTADO Y FUNCIONAL
model Gasto {
  gastoRecurrenteId  Int?              @map("gastoRecurrenteId")
  gastoRecurrente    GastoRecurrente?  @relation(fields: [gastoRecurrenteId], references: [id])
}

model GastoRecurrente {
  gastosGenerados   Gasto[]           @relation()
  estado           String            // 'pendiente', 'pago_parcial', 'pagado'
}
```

#### Componentes UI EstÃ¡ndar âœ…
```typescript
// NotificationCenter en header - IMPLEMENTADO Y FUNCIONAL
export function NotificationCenter() {
  const { alertas, stats } = useAlertas()
  const { valuesVisible } = useVisibility()
  return (
    <DropdownMenu>
      <Bell />
      <Badge>{stats.noLeidas}</Badge>
      {/* Lista de alertas con acciones */}
    </DropdownMenu>
  )
}

// AlertsList para gestiÃ³n completa - IMPLEMENTADO Y FUNCIONAL
export function AlertsList({ alertas, onMarcarLeida, onEliminar }) {
  // Componente completo con filtros, acciones y estados
}

// Componentes de IA - IMPLEMENTADOS Y FUNCIONALES
export function PatronesAnalisis() {
  // AnÃ¡lisis de patrones con OpenAI
}

export function RecomendacionesIA() {
  // Recomendaciones personalizadas
}

// Selector de Gastos Recurrentes - IMPLEMENTADO Y FUNCIONAL
export function GastoRecurrenteSelector({ value, onChange, gastosRecurrentes }) {
  return (
    <Select value={value || "none"} onValueChange={onChange}>
      <SelectTrigger>
        <SelectValue placeholder="Seleccionar gasto recurrente" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="none">Sin asociar</SelectItem>
        {gastosRecurrentes.map(recurrente => (
          <SelectItem key={recurrente.id} value={recurrente.id.toString()}>
            {recurrente.concepto} - ${recurrente.monto.toLocaleString()}
            {recurrente.estado === 'pago_parcial' && 
              ` (${recurrente.porcentajePagado.toFixed(1)}% pagado)`
            }
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  )
}
```

#### APIs Implementadas y Funcionales âœ…
- âœ… `GET /api/alertas` - Listar alertas con filtros y paginaciÃ³n
- âœ… `POST /api/alertas` - Crear nueva alerta  
- âœ… `PUT /api/alertas/[id]` - Actualizar alerta
- âœ… `DELETE /api/alertas/[id]` - Eliminar alerta
- âœ… `GET/PUT /api/alertas/config` - Configuraciones de usuario
- âœ… `POST /api/alertas/test` - Crear alertas de prueba (con CORS)
- âœ… `POST /api/alertas/evaluate` - EvaluaciÃ³n automÃ¡tica de condiciones
- âœ… `GET /api/alertas/scheduler` - Estado del scheduler automÃ¡tico
- âœ… `POST /api/alertas/scheduler` - Control del scheduler (start/stop/runOnce)
- âœ… `GET /api/ai/analizar-patrones` - AnÃ¡lisis de patrones con IA
- âœ… `GET /api/ai/recomendaciones` - Recomendaciones personalizadas
- âœ… `GET /api/ai/alertas-predictivas` - Alertas predictivas
- âœ… `GET /api/ai/reporte-inteligente` - Reportes ejecutivos con IA
- âœ… `GET /api/ai/detectar-anomalias` - DetecciÃ³n de gastos anÃ³malos
- âœ… `POST /api/gastos` - Crear transacciÃ³n con soporte para gastoRecurrenteId
- âœ… `PUT /api/gastos/[id]` - Editar transacciÃ³n con manejo de asociaciones
- âœ… `GET /api/gastos/recurrentes-disponibles` - Lista optimizada para selector
- âœ… `GET /api/gastos/familiares` - Transacciones familiares para administradores
- âœ… `POST /api/recurrentes/[id]/generar-pago` - GeneraciÃ³n automÃ¡tica

## Estructura del Proyecto
```
src/
â”œâ”€â”€ app/                    # App Router de Next.js
â”‚   â”œâ”€â”€ api/               # API Routes
â”‚   â”‚   â”œâ”€â”€ ai/            # âœ… APIs de Inteligencia Artificial (FASE 3)
â”‚   â”‚   â”œâ”€â”€ alertas/       # âœ… Sistema de alertas completo (FASE 1+2)
â”‚   â”‚   â”œâ”€â”€ gastos/        # âœ… GestiÃ³n de transacciones + gastos recurrentes
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/      # âœ… CRUD individual con asociaciÃ³n
â”‚   â”‚   â”‚   â””â”€â”€ recurrentes-disponibles/ # âœ… API para selector
â”‚   â”‚   â”œâ”€â”€ recurrentes/   # âœ… GestiÃ³n completa gastos recurrentes
â”‚   â”‚   â”‚   â””â”€â”€ [id]/generar-pago/ # âœ… GeneraciÃ³n automÃ¡tica
â”‚   â”‚   â”œâ”€â”€ prestamos/     # GestiÃ³n de prÃ©stamos
â”‚   â”‚   â”œâ”€â”€ inversiones/   # GestiÃ³n de inversiones
â”‚   â”‚   â”œâ”€â”€ tareas/        # Sistema de tareas
â”‚   â”‚   â””â”€â”€ ...           # Otras APIs
â”‚   â”œâ”€â”€ admin/             # Panel de administraciÃ³n
â”‚   â”‚   â”œâ”€â”€ alertas/       # âœ… Control del motor automÃ¡tico (FASE 2)
â”‚   â”‚   â”œâ”€â”€ categorias/    # GestiÃ³n de categorÃ­as
â”‚   â”‚   â””â”€â”€ ...           # Otras administraciones
â”‚   â”œâ”€â”€ dashboard/         # Dashboard principal
â”‚   â”œâ”€â”€ ai-financiero/     # âœ… Centro de IA (FASE 3)
â”‚   â”œâ”€â”€ alertas/           # âœ… Centro de alertas (FASE 1)
â”‚   â”œâ”€â”€ test-alertas/      # âœ… PÃ¡gina de pruebas (FASE 1)
â”‚   â”œâ”€â”€ test-fase2/        # âœ… PÃ¡gina de pruebas (FASE 2)
â”‚   â”œâ”€â”€ test-fase3/        # âœ… PÃ¡gina de pruebas (FASE 3)
â”‚   â”œâ”€â”€ transacciones/     # âœ… GestiÃ³n con selector gastos recurrentes
â”‚   â”‚   â”œâ”€â”€ nuevo/         # âœ… Formulario con asociaciÃ³n
â”‚   â”‚   â””â”€â”€ [id]/editar/   # âœ… EdiciÃ³n con manejo de cambios
â”‚   â”œâ”€â”€ recurrentes/       # âœ… GestiÃ³n completa implementada
â”‚   â”œâ”€â”€ grupos/            # Gastos grupales
â”‚   â”œâ”€â”€ prestamos/         # GestiÃ³n de prÃ©stamos
â”‚   â”œâ”€â”€ inversiones/       # GestiÃ³n de inversiones
â”‚   â”œâ”€â”€ tareas/            # Sistema de tareas
â”‚   â””â”€â”€ ...
â”œâ”€â”€ components/            # Componentes reutilizables
â”‚   â”œâ”€â”€ ui/               # Componentes UI de Shadcn
â”‚   â”œâ”€â”€ alertas/          # âœ… Componentes de alertas (FASE 1)
â”‚   â”œâ”€â”€ ai/               # âœ… Componentes de IA (FASE 3)
â”‚   â””â”€â”€ ExpenseForm.tsx   # âœ… Con selector gastos recurrentes
â”œâ”€â”€ lib/                  # Utilidades y configuraciones
â”‚   â”œâ”€â”€ alert-engine/     # âœ… Motor de alertas automÃ¡tico (FASE 2)
â”‚   â”œâ”€â”€ ai/               # âœ… Motor de inteligencia artificial (FASE 3)
â”‚   â””â”€â”€ prisma.ts         # âœ… ConfiguraciÃ³n optimizada Next.js 15
â”œâ”€â”€ contexts/             # Contextos de React
â”‚   â”œâ”€â”€ VisibilityContext.tsx   # âœ… Implementado
â”‚   â””â”€â”€ ThemeProvider.tsx       # âœ… Implementado
â”œâ”€â”€ providers/            # Proveedores de la aplicaciÃ³n
â”‚   â””â”€â”€ ThemeProvider.tsx       # âœ… Implementado
â””â”€â”€ scraping/             # Sistema de scraping para promociones
```

## Reglas de Desarrollo

### 1. Arquitectura y Patrones
- Usar App Router de Next.js 15 exclusivamente
- Implementar Server Components por defecto, Client Components solo cuando sea necesario
- Seguir el patrÃ³n de separaciÃ³n de responsabilidades: UI, lÃ³gica de negocio, acceso a datos
- Usar TypeScript estricto con tipos explÃ­citos
- Implementar error boundaries y manejo de errores robusto

### 2. Base de Datos y Prisma
- **IMPORTANTE**: La aplicaciÃ³n usa PostgreSQL/Neon tanto en desarrollo como producciÃ³n
- Usar `npx prisma db push` para cambios de schema (NO usar migraciones automÃ¡ticas)
- Siempre usar `prisma.$transaction()` para operaciones que requieren atomicidad
- Validar datos antes de enviar a la base de datos
- Usar tipos generados por Prisma para type safety

### 3. AutenticaciÃ³n y AutorizaciÃ³n
- Usar NextAuth.js v4 para autenticaciÃ³n
- Implementar middleware para proteger rutas
- Validar sesiones en API routes usando `getServerSession()`
- Manejar roles de usuario (admin, usuario regular)
- Proteger rutas sensibles del panel de administraciÃ³n

### 4. API Routes
- Usar mÃ©todos HTTP apropiados (GET, POST, PUT, DELETE)
- Implementar validaciÃ³n de entrada con Zod
- Manejar errores de forma consistente con cÃ³digos HTTP apropiados
- Usar `NextRequest` y `NextResponse` para tipado
- Implementar rate limiting para endpoints sensibles

### 5. Componentes UI
- Usar componentes de Shadcn/ui como base
- Implementar componentes accesibles (ARIA labels, keyboard navigation)
- Usar TailwindCSS para estilos, evitar CSS custom
- Implementar loading states y skeleton loaders
- Usar Lucide React para iconos
- **Integrar con VisibilityContext para ocultaciÃ³n de valores**
- **Soportar ThemeProvider para modo oscuro por defecto**

### 6. GestiÃ³n de Estado
- Usar React Context para estado global (Currency, Sidebar, Visibility, Theme)
- Implementar custom hooks para lÃ³gica reutilizable
- Usar `useState` y `useEffect` apropiadamente
- Evitar prop drilling excesivo

### 7. Formularios y ValidaciÃ³n
- Usar React Hook Form para formularios complejos
- Implementar validaciÃ³n con Zod
- Manejar estados de loading y error en formularios
- Usar componentes controlados para inputs crÃ­ticos

### 8. Funcionalidades EspecÃ­ficas

#### Transacciones y Gastos
- Validar montos y fechas antes de guardar
- Implementar categorizaciÃ³n automÃ¡tica
- Manejar diferentes tipos de movimiento (efectivo, digital, ahorro, tarjeta)
- Soporte para gastos grupales y individuales
- **âœ… AsociaciÃ³n con gastos recurrentes** en creaciÃ³n y ediciÃ³n
- **âœ… CÃ¡lculo automÃ¡tico de estados** (pendiente/pago_parcial/pagado)
- **âœ… Modo familiar** - Toggle para administradores ver transacciones de toda la familia

#### **Sistema de Gastos Recurrentes (COMPLETADO)**
- **âœ… RelaciÃ³n padre-hijo** con campo `gastoRecurrenteId` en tabla Gasto
- **âœ… Estados automÃ¡ticos** calculados en tiempo real basados en pagos asociados
- **âœ… Selector dinÃ¡mico** en formularios de transacciones con informaciÃ³n visual
- **âœ… API optimizada** `/api/gastos/recurrentes-disponibles` con timeouts
- **âœ… GeneraciÃ³n automÃ¡tica** de transacciones desde gastos recurrentes
- **âœ… Transacciones atÃ³micas** para garantizar consistencia de datos
- **âœ… Manejo de cambios** de asociaciÃ³n (Aâ†’B, Aâ†’ninguno, ningunoâ†’A)
- **âœ… InformaciÃ³n visual** del impacto de pagos y saldos pendientes

#### PrÃ©stamos
- Calcular cuotas usando amortizaciÃ³n francesa
- Registrar pagos automÃ¡ticamente como gastos
- Manejar estados del prÃ©stamo (activo, pagado, vencido)
- Validar fechas de pago y vencimiento
- **Alertas automÃ¡ticas** de cuotas prÃ³ximas

#### Inversiones
- Registrar transacciones de inversiÃ³n (depÃ³sitos, retiros, dividendos)
- Calcular rendimientos automÃ¡ticamente
- Manejar cotizaciones histÃ³ricas
- Soporte para diferentes tipos de inversiÃ³n
- **Alertas automÃ¡ticas** de vencimientos

#### Sistema de Scraping
- Implementar scrapers robustos con manejo de errores
- Usar Puppeteer para sitios que requieren JavaScript
- Implementar rate limiting y respeto por robots.txt
- Guardar promociones con fechas de vencimiento

#### **Sistema de Alertas (COMPLETADO)**
- **Usar AlertEngine** para evaluaciÃ³n automÃ¡tica de condiciones
- **Implementar diferentes tipos** de alerta segÃºn prioridad
- **Soporte para mÃºltiples canales** (in-app activo, email/SMS/WhatsApp preparado)
- **ConfiguraciÃ³n granular** por usuario completamente funcional
- **IntegraciÃ³n con OpenAI** para alertas inteligentes implementada

#### **Motor AutomÃ¡tico (COMPLETADO)**
- **AlertScheduler funcionando** con patrÃ³n Singleton
- **EvaluaciÃ³n cada 60 minutos** configurable
- **Control completo** start/stop/runOnce
- **Limpieza automÃ¡tica** de alertas expiradas
- **Panel de administraciÃ³n** completamente operativo

#### **Inteligencia Artificial (COMPLETADO)**
- **AIAnalyzer integrado** con OpenAI
- **5 tipos de anÃ¡lisis** funcionando correctamente
- **Prompts especializados** en finanzas en espaÃ±ol
- **Respuestas estructuradas** JSON validadas
- **Centro de IA** completamente funcional

### 9. Performance y OptimizaciÃ³n
- Usar `loading.tsx` y `error.tsx` en rutas
- Implementar lazy loading para componentes pesados
- Optimizar consultas a la base de datos (incluir relaciones necesarias)
- Usar `Suspense` para componentes que cargan datos
- **Configurar timeouts** para APIs de OpenAI

### 10. Seguridad
- Validar todas las entradas del usuario
- Sanitizar datos antes de mostrar en UI
- Usar HTTPS en producciÃ³n
- Implementar CSRF protection
- No exponer informaciÃ³n sensible en el cliente
- **Proteger API keys** de OpenAI

### 11. Manejo de Errores
- Implementar try-catch en todas las operaciones async
- Usar toast notifications para feedback al usuario
- Loggear errores apropiadamente
- Implementar fallbacks para componentes que fallan
- **Manejo especÃ­fico** de errores de OpenAI

### 12. InternacionalizaciÃ³n
- Usar formato de moneda argentino (ARS) por defecto
- Implementar fechas en espaÃ±ol con date-fns
- Usar formato de nÃºmeros apropiado para Argentina

### 13. Testing y Calidad
- Escribir tests para funciones crÃ­ticas
- Usar ESLint y Prettier para consistencia de cÃ³digo
- Implementar type checking estricto
- Documentar funciones complejas
- **Usar pÃ¡ginas de prueba** implementadas

### 14. Deployment y ConfiguraciÃ³n
- Usar variables de entorno para configuraciÃ³n
- Implementar scripts PowerShell para desarrollo local
- Configurar Vercel para deployment automÃ¡tico
- Usar Neon para base de datos en producciÃ³n
- **Configurar Plan Pro** de Vercel para timeouts de IA

## Variables de Entorno Requeridas
```bash
DATABASE_URL=postgresql://...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=...
OPENAI_API_KEY=... # âœ… REQUERIDO para funcionalidades de IA
TWILIO_ACCOUNT_SID=... # Opcional para notificaciones
TWILIO_AUTH_TOKEN=... # Opcional para notificaciones
```

## Comandos de Desarrollo
```powershell
npm run dev:full        # Iniciar con variables de entorno
npm run studio          # Prisma Studio con variables
npx prisma db push      # Sincronizar schema
npx prisma generate     # Generar cliente

# ğŸ–¥ï¸ COMANDOS WINDOWS/POWERSHELL ESPECÃFICOS
.\start-dev.ps1         # Script PowerShell de desarrollo
Set-Location "ruta"     # Cambiar directorio (NO usar cd en algunos contextos)
Get-ChildItem          # Listar archivos (NO usar ls)
```

## ğŸš¨ REGLAS CRÃTICAS DE SEGURIDAD

### âŒ PROHIBICIONES ABSOLUTAS
- **NUNCA borrar datos de la base de datos**: No usar DELETE, TRUNCATE, DROP
- **NUNCA resetear la base de datos**: No usar reset, seed destructivos
- **NUNCA usar comandos Linux**: No usar bash, sh, cd, ls en comandos
- **NUNCA simular datos**: Solo trabajar con datos reales del usuario

## Patrones de CÃ³digo EspecÃ­ficos

### API Route Pattern
```typescript
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'No autorizado' }, { status: 401 })
    }
    
    // LÃ³gica del endpoint
    
    return NextResponse.json(data)
  } catch (error) {
    console.error('Error:', error)
    return NextResponse.json({ error: 'Error interno' }, { status: 500 })
  }
}
```

### Component Pattern
```typescript
interface ComponentProps {
  // Props tipadas
}

export function Component({ prop }: ComponentProps) {
  const [loading, setLoading] = useState(false)
  const { valuesVisible } = useVisibility() // Usar contexto de visibilidad
  const { theme } = useTheme() // Usar contexto de tema
  
  // LÃ³gica del componente
  
  if (loading) return <Skeleton />
  
  return (
    <div className="space-y-4">
      {/* JSX con soporte para visibilidad y tema */}
    </div>
  )
}
```

### Database Query Pattern
```typescript
const result = await prisma.gasto.findMany({
  where: { userId: session.user.id },
  include: {
    categoria: true,
    user: true
  },
  orderBy: { fecha: 'desc' }
})
```

### **OpenAI Integration Pattern** âœ…
```typescript
const response = await openai.chat.completions.create({
  model: "gpt-3.5-turbo", // o "gpt-4o-mini"
  messages: [
    {
      role: "system",
      content: "Eres un asistente financiero especializado..."
    },
    {
      role: "user", 
      content: prompt
    }
  ],
  temperature: 0.3,
  response_format: { type: "json_object" }
})
```

### **Next.js 15 API Route Pattern** âœ…
```typescript
// CORRECTO: Uso de await params para Next.js 15
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const { id: idParam } = await params  // âœ… Await params requerido
    
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'No autorizado' }, { status: 401 })
    }
    
    // Resto de la lÃ³gica...
    
    return NextResponse.json(data)
  } catch (error) {
    console.error('Error:', error)
    return NextResponse.json({ error: 'Error interno' }, { status: 500 })
  }
}
```

### **Gastos Recurrentes Pattern** âœ…
```typescript
// Crear transacciÃ³n con asociaciÃ³n a gasto recurrente
export async function POST(request: NextRequest) {
  const { gastoRecurrenteId, ...datos } = await request.json()
  
  // Validar gasto recurrente si se proporciona
  let gastoRecurrente = null
  if (gastoRecurrenteId) {
    gastoRecurrente = await prisma.gastoRecurrente.findFirst({
      where: { id: Number(gastoRecurrenteId), userId: usuario.id }
    })
    
    if (!gastoRecurrente) {
      return NextResponse.json({ error: 'Gasto recurrente no vÃ¡lido' }, { status: 400 })
    }
  }
  
  // TransacciÃ³n atÃ³mica para crear gasto y actualizar estado
  const resultado = await prisma.$transaction(async (tx) => {
    const nuevoGasto = await tx.gasto.create({
      data: {
        ...datos,
        gastoRecurrenteId: gastoRecurrenteId ? Number(gastoRecurrenteId) : null
      }
    })
    
    // Recalcular estado del recurrente si estÃ¡ asociado
    if (gastoRecurrente) {
      const totalPagado = await tx.gasto.aggregate({
        where: { gastoRecurrenteId: gastoRecurrente.id },
        _sum: { monto: true }
      })
      
      const montoPagado = totalPagado._sum.monto || 0
      const nuevoEstado = montoPagado >= gastoRecurrente.monto 
        ? 'pagado' 
        : montoPagado > 0 
          ? 'pago_parcial' 
          : 'pendiente'
      
      await tx.gastoRecurrente.update({
        where: { id: gastoRecurrente.id },
        data: { estado: nuevoEstado, ultimoPago: new Date() }
      })
    }
    
    return nuevoGasto
  })
  
  return NextResponse.json(resultado)
}
```

### **Performance Pattern con Timeouts** âœ…
```typescript
// Query con timeout para evitar problemas en Neon
const gastosRecurrentes = await Promise.race([
  prisma.gastoRecurrente.findMany({
    where: { userId: usuario.id, estado: { in: ['pendiente', 'pago_parcial'] } },
    include: {
      categoria: { select: { id: true, descripcion: true } },
      gastosGenerados: { 
        select: { id: true, monto: true, fecha: true },
        take: 10 // Limitar para performance
      }
    },
    take: 50 // MÃ¡ximo 50 resultados
  }),
  new Promise((_, reject) => 
    setTimeout(() => reject(new Error('Timeout en query')), 15000)
  )
]) as any

// Enriquecimiento de datos con cÃ¡lculos
const gastosConInfo = gastosRecurrentes.map(recurrente => {
  const totalPagado = recurrente.gastosGenerados.reduce((sum, pago) => sum + pago.monto, 0)
  return {
    ...recurrente,
    totalPagado,
    saldoPendiente: recurrente.monto - totalPagado,
    porcentajePagado: (totalPagado / recurrente.monto) * 100
  }
})
```

### **Formulario con Selector de Gastos Recurrentes** âœ…
```typescript
// Componente con selector de gastos recurrentes
export function ExpenseForm() {
  const [gastosRecurrentes, setGastosRecurrentes] = useState([])
  const [gastoRecurrenteId, setGastoRecurrenteId] = useState("")
  const [gastoRecurrenteSeleccionado, setGastoRecurrenteSeleccionado] = useState(null)
  
  // Cargar gastos recurrentes disponibles
  useEffect(() => {
    fetch('/api/gastos/recurrentes-disponibles')
      .then(res => res.json())
      .then(setGastosRecurrentes)
      .catch(console.error)
  }, [])
  
  // Auto-llenado al seleccionar recurrente
  const handleGastoRecurrenteChange = (value: string) => {
    setGastoRecurrenteId(value === "none" ? "" : value)
    
    if (value !== "none") {
      const recurrente = gastosRecurrentes.find(g => g.id.toString() === value)
      setGastoRecurrenteSeleccionado(recurrente)
      if (recurrente) {
        setConcepto(recurrente.concepto) // Auto-llenar concepto
      }
    } else {
      setGastoRecurrenteSeleccionado(null)
    }
  }
  
  return (
    <form>
      {/* Selector de gasto recurrente */}
      <Select value={gastoRecurrenteId || "none"} onValueChange={handleGastoRecurrenteChange}>
        <SelectTrigger>
          <SelectValue placeholder="Seleccionar gasto recurrente" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="none">Sin asociar</SelectItem>
          {gastosRecurrentes.map(recurrente => (
            <SelectItem key={recurrente.id} value={recurrente.id.toString()}>
              {recurrente.concepto} - ${recurrente.monto.toLocaleString()}
              {recurrente.estado === 'pago_parcial' && 
                ` (${recurrente.porcentajePagado.toFixed(1)}% pagado)`
              }
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      
      {/* InformaciÃ³n visual del impacto */}
      {gastoRecurrenteSeleccionado && (
        <div className="bg-blue-50 dark:bg-blue-950 p-3 rounded-lg mt-2">
          <p className="text-sm font-medium">Impacto del pago:</p>
          <p className="text-xs">
            Saldo pendiente: ${gastoRecurrenteSeleccionado.saldoPendiente.toLocaleString()}
          </p>
          <p className="text-xs">
            Con este pago: {calcularNuevoEstado(gastoRecurrenteSeleccionado, monto)}
          </p>
        </div>
      )}
      
      {/* Resto del formulario... */}
    </form>
  )
}
```

### **Modo Familiar Pattern** âœ…
```typescript
// Componente con modo familiar para administradores
export function TransaccionesPage() {
  const [modoFamiliar, setModoFamiliar] = useState(false)
  const { esAdministradorFamiliar } = usePermisosFamiliares()
  
  // Fetch automÃ¡tico segÃºn modo
  const fetchGastosPersonales = async () => {
    const endpoint = (modoFamiliar && esAdministradorFamiliar) 
      ? '/api/gastos/familiares' 
      : '/api/gastos'
    
    const response = await fetch(endpoint)
    const data = await response.json()
    
    if (modoFamiliar && data.gastos) {
      setGastosPersonales(data.gastos) // API familiar
    } else {
      setGastosPersonales(data) // API personal
    }
  }
  
  return (
    <div>
      {/* Toggle modo familiar */}
      {esAdministradorFamiliar && (
        <div className="mb-4 p-3 border rounded-lg bg-blue-50 dark:bg-blue-950">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium">
              {modoFamiliar ? 'Ver transacciones familiares' : 'Ver mis transacciones'}
            </span>
            <Button
              variant={modoFamiliar ? "default" : "outline"}
              size="sm"
              onClick={() => setModoFamiliar(!modoFamiliar)}
              className="gap-2"
            >
              {modoFamiliar ? (
                <>
                  <User className="h-4 w-4" />
                  Cambiar a Personal
                </>
              ) : (
                <>
                  <Users className="h-4 w-4" />
                  Ver Familia
                </>
              )}
            </Button>
          </div>
        </div>
      )}
      
      {/* Lista de transacciones con identificaciÃ³n de usuario */}
      {gastosFiltrados.map((movimiento) => (
        <div key={movimiento.id}>
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            {modoFamiliar && movimiento.user?.name && (
              <Badge variant="outline" className="text-xs bg-purple-50 text-purple-700 border-purple-200">
                {movimiento.user.name}
              </Badge>
            )}
            {/* Resto de badges... */}
          </div>
        </div>
      ))}
    </div>
  )
}
```

## Notas Importantes
- **NO usar datos simulados o ficticios**
- **NO implementar reseteo automÃ¡tico de base de datos**
- **Siempre validar permisos de usuario antes de operaciones**
- **Usar PostgreSQL/Neon exclusivamente (no SQLite)**
- **Mantener consistencia en el formato de fechas y monedas**
- **âœ… PROYECTO COMPLETADO**: Las 3 fases + gastos recurrentes implementados y funcionando
- **Usar contextos de Visibility y Theme en todos los componentes nuevos**
- **âœ… OpenAI integrado**: Usar AIAnalyzer para nuevas funcionalidades de IA
- **âœ… AlertEngine funcionando**: Usar para evaluar nuevas condiciones automÃ¡ticas
- **âœ… Gastos Recurrentes**: Sistema completo con asociaciÃ³n bidireccional implementado
- **âœ… Modo Familiar**: Toggle personal/familiar con control de permisos para administradores
- **âœ… Next.js 15**: Usar `await params` en todas las API routes nuevas
- **âœ… Performance**: Implementar timeouts en queries crÃ­ticas para evitar problemas con Neon
- **âœ… PÃ¡ginas de prueba disponibles**: `/test-alertas`, `/test-fase2`, `/test-fase3`, `/recurrentes`